<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rabbit Miner Pro + Web3</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff9800;
            --primary-glow: rgba(255, 152, 0, 0.6);
            --bg: #08080a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text-secondary: #a0a0a0;
            --danger: #ff4444;
            --success: #00c851;
            --web3-primary: #3b82f6; /* Blue for Web3 */
            --web3-glow: rgba(59, 130, 246, 0.6);
        }
        body {
            margin: 0;
            background: radial-gradient(circle at top, #1a1a1f 0%, #08080a 100%);
            color: white;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- LOADING --- */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader-number {
            font-family: 'Orbitron', sans-serif;
            font-size: 60px; color: var(--primary);
            text-shadow: 0 0 20px var(--primary-glow); margin-bottom: 20px;
        }
        .loader-bar-bg { width: 70%; height: 6px; background: #222; border-radius: 10px; overflow: hidden; }
        .loader-bar-fill { height: 100%; width: 0%; background: var(--primary); box-shadow: 0 0 10px var(--primary); transition: width 0.1s linear; }

        /* --- MODALS (Generic) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); z-index: 10000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .modal-box {
            background: #151518; border: 1px solid var(--border);
            width: 85%; max-width: 350px; padding: 25px; border-radius: 24px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
        }
        .btn-row { display: flex; gap: 15px; margin-top: 20px; }
        .btn-agree, .btn-deny { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
        .btn-agree { background: linear-gradient(135deg, var(--primary), #ff6d00); color: white; }
        .btn-deny { background: #2a2a2a; color: #ff4444; border: 1px solid #ff4444; }

        /* --- MAIN UI WRAPPER --- */
        #main-app { width: 100%; height: 100%; transition: transform 0.3s ease; }
        
        .top-bar { 
            position: fixed; top: 0; left: 0; width: 100%; background: var(--bg); z-index: 50; 
            padding: 10px 0 15px 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        /* New Web3 Button styling */
        .web3-btn-top {
            display: inline-block; background: linear-gradient(90deg, #3b82f6, #2563eb);
            padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold;
            margin-bottom: 8px; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); cursor: pointer;
        }

        .balance-area { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .coin-icon { font-size: 30px; filter: drop-shadow(0 0 10px var(--primary-glow)); }
        #coins {
            font-size: 32px; font-family: 'Orbitron', sans-serif; font-weight: 700;
            background: linear-gradient(to bottom, #fff, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; padding: 0 20px; }
        .stat-box { background: var(--card-bg); border: 1px solid var(--border); padding: 8px; border-radius: 12px; backdrop-filter: blur(10px); }
        .stat-box small { display: block; color: var(--text-secondary); font-size: 10px; text-transform: uppercase; margin-bottom: 4px; }
        .stat-box b { font-size: 14px; color: #fff; }

        .page {
            display: none; flex-direction: column; align-items: center; width: 100%; height: 100vh;
            overflow-y: auto; -webkit-overflow-scrolling: touch; padding-top: 160px; padding-bottom: 100px; box-sizing: border-box;
            position: absolute; top: 0; left: 0;
        }
        .active-page { display: flex; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* RABBIT */
        .rabbit-container { flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin: 10px 0; }
        .circle-outer { width: 280px; height: 280px; border-radius: 50%; background: rgba(255, 152, 0, 0.05); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255, 152, 0, 0.1); }
        .rabbit-main { width: 240px; height: 240px; background: radial-gradient(circle, #2a2a2a, #000); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 100px; cursor: pointer; box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,152,0,0.1); border: 5px solid #1a1a1a; transition: all 0.1s; user-select: none; -webkit-user-select: none; overflow: hidden; line-height: 1; }
        .rabbit-main:active { transform: scale(0.95); }
        .rabbit-main.tapped { animation: tapBounce 0.4s ease-out; box-shadow: 0 0 70px var(--primary-glow); }
        @keyframes tapBounce { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }

        /* ENERGY */
        .energy-container { margin-top: 10px; width: 80%; text-align: center; }
        .energy-bar-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin: 5px 0; }
        #energy-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #f57c00); width: 100%; transition: width 0.3s ease; }
        
        .float { position: absolute; font-family: 'Orbitron', sans-serif; font-weight: bold; color: #fff; font-size: 24px; pointer-events: none; animation: floatUp 0.8s ease-out forwards; text-shadow: 0 0 5px #000; z-index: 100; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.2); } }

        /* BUTTONS & CARDS */
        .upgrade-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px; width: 100%; box-sizing: border-box; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 15px; text-align: center; margin-bottom: 10px; }
        .btn-prime { background: linear-gradient(90deg, #ff9800, #f57c00); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 600; margin-top: 5px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); transition: all 0.2s; }
        .btn-prime:active { transform: scale(0.98); }
        .btn-prime:disabled { background: #333; color: #777; box-shadow: none; cursor: not-allowed; }
        .glow-btn { animation: glowing 2s infinite; }
        @keyframes glowing { 0% { box-shadow: 0 0 5px #ff9800; } 50% { box-shadow: 0 0 20px #ff9800; } 100% { box-shadow: 0 0 5px #ff9800; } }

        /* PREMIUM SKIN MODAL */
        .skin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; max-height: 60vh; overflow-y: auto; padding: 5px; }
        .skin-item { background: #1a1a1f; border-radius: 15px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; transition: 0.2s; }
        .skin-item:active { transform: scale(0.98); }
        .skin-item.owned { border-color: var(--success); background: rgba(0, 200, 81, 0.1); }
        .skin-item.selected { border: 2px solid var(--primary); box-shadow: 0 0 15px rgba(255, 152, 0, 0.2); }
        .skin-icon { font-size: 45px; display: block; margin-bottom: 8px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
        
        /* NAVBAR */
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 65px; background: rgba(20, 20, 25, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.6); padding: 0 5px; }
        .nav-item { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; padding: 5px; width: 50px; transition: 0.3s; border-radius: 20px; }
        .nav-item .icon-box { font-size: 20px; margin-bottom: 2px; transition: 0.3s; filter: grayscale(1); }
        .nav-item.active { color: #fff; transform: translateY(-5px); }
        .nav-item.active .icon-box { transform: scale(1.1); filter: grayscale(0) drop-shadow(0 0 8px var(--primary)); }

        /* --- WEB3 SECTION STYLES --- */
        #web3-app {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 5000; flex-direction: column;
            overflow-y: auto;
        }
        .web3-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(180deg, rgba(59, 130, 246, 0.1), transparent); }
        .back-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        .web3-card {
            background: rgba(30, 30, 35, 0.8); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px; padding: 20px; margin: 15px 20px;
        }
        .b-coin {
            display: inline-flex; width: 40px; height: 40px; background: var(--web3-primary);
            border-radius: 50%; color: white; font-weight: 900; font-family: 'Orbitron';
            align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 0 15px var(--web3-glow); margin-right: 10px;
        }

        .web3-nav {
            display: flex; justify-content: center; gap: 15px; margin-top: 20px; padding-bottom: 30px;
        }
        .w-nav-btn {
            background: #1a1a1f; color: #888; border: 1px solid #333;
            padding: 10px 20px; border-radius: 12px; font-weight: bold; font-size: 13px;
        }
        .w-nav-btn.active {
            background: var(--web3-primary); color: white; border-color: var(--web3-primary);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        /* WEB3 SECTIONS */
        .w-section { display: none; padding-bottom: 50px; }
        .w-active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* GAME CANVAS */
        #game-canvas {
            background: #70c5ce; /* Sky blue */
            border-radius: 15px; margin: 0 auto; display: block;
            border: 2px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        /* CONVERT UI */
        .convert-box {
            display: flex; align-items: center; justify-content: space-between;
            background: #111; padding: 15px; border-radius: 15px; margin-bottom: 10px;
        }
        .convert-inp {
            background: transparent; border: none; color: white; font-size: 20px; width: 100px;
            font-family: 'Orbitron'; outline: none;
        }
        .swap-icon { font-size: 24px; color: #888; }
        
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-number" id="loader-count">0%</div>
        <div class="loader-bar-bg"><div class="loader-bar-fill" id="loader-fill"></div></div>
        <p style="color:#666; margin-top:10px; font-size:12px;">Loading Assets...</p>
    </div>

    <div id="agreement-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>WELCOME</h2>
            <div style="color:#ccc; font-size:13px; line-height:1.5;">
                By entering <b>Rabbit Miner Pro</b>, you agree to our Terms.<br><br>
                Play fair, mine carrots, and enjoy!
            </div>
            <div class="btn-row">
                <button class="btn-deny" onclick="handleAgreement(false)">DENY</button>
                <button class="btn-agree" onclick="handleAgreement(true)">AGREE</button>
            </div>
        </div>
    </div>

    <div id="skin-confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="sc-title" style="margin-top:0;">Confirm</h2>
            <div id="sc-icon" style="font-size:60px; margin:10px 0;"></div>
            <p id="sc-desc" style="color:#aaa; font-size:13px;"></p>
            <div class="btn-row">
                <button class="btn-deny" onclick="closeSkinConfirm()">NO</button>
                <button class="btn-agree" id="sc-yes-btn">YES</button>
            </div>
        </div>
    </div>

    <div id="skin-modal" class="modal-overlay">
        <div class="modal-box" style="width:90%; max-width:400px; padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Skin Shop</h3>
                <button onclick="closeSkins()" style="background:none; border:none; color:red; font-size:24px;">&times;</button>
            </div>
            <div class="skin-grid" id="skin-list"></div>
        </div>
    </div>

    <div id="main-app">
        <div class="top-bar">
            <div class="web3-btn-top" onclick="openWeb3()">
                üåê Web3
            </div>

            <div class="balance-area">
                <span class="coin-icon">ü•ï</span>
                <span id="coins">0</span>
            </div>
            <div class="stats-grid">
                <div class="stat-box">
                    <small>Profit / Hr</small>
                    <b id="pph">0</b>
                </div>
                <div class="stat-box">
                    <small>Daily Reward</small>
                    <b id="daily-estimate">0</b>
                </div>
            </div>
        </div>

        <div id="home" class="page active-page">
            <div class="rabbit-container">
                <div class="circle-outer">
                    <div class="rabbit-main" id="tap-btn">üê∞</div>
                </div>
                <div class="energy-container">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                        <span>Energy</span>
                        <span id="energy-text">1000 / 1000</span>
                    </div>
                    <div class="energy-bar-bg">
                        <div id="energy-fill"></div>
                    </div>
                </div>
            </div>
            
            <button class="btn-prime glow-btn" id="daily-btn" style="width: 85%; margin-bottom: 10px;">
                Claim Daily
            </button>
            
            <button class="btn-prime" style="width: 85%; background: #333; margin-bottom: 20px;" onclick="nav('boost', document.getElementById('boost-nav'))">
                  üöÄ BOOSTERS
            </button>
        </div>

        <div id="upgrade" class="page">
            <div style="width:90%; margin-bottom:15px;">
                <button class="btn-prime" onclick="openSkins()" style="background: linear-gradient(45deg, #9c27b0, #673ab7);">
                      üé® Premium Skins (Shop)
                </button>
            </div>
            <h3 style="margin-top:0;">Upgrades</h3>
            <div class="upgrade-grid" id="upgrade-list"></div>
        </div>

        <div id="boost" class="page">
            <h3 style="margin-top:0;">Boosters</h3>
            
            <div class="card" style="width: 80%; margin: 10px auto;">
                <h4>‚ö° Full Energy Refill</h4>
                <p style="color: var(--text-secondary); font-size: 13px;">Refill energy instantly.</p>
                <button class="btn-prime" id="refill-btn" onclick="refill()">Refill (5/5)</button>
            </div>

            <div class="card" style="width: 80%; margin: 10px auto; border: 1px solid #ff4444;">
                <h4 style="color:#ff4444;">üî• Turbo Rabbit (x5)</h4>
                <p style="color: var(--text-secondary); font-size: 13px;">Free x5 Multiplier (100 Taps)</p>
                <p id="turbo-timer" style="font-size:11px; color:#888;">Resets every 24h</p>
                <button class="btn-prime" id="turbo-btn" onclick="activateTurbo()">
                    Activate (5/5)
                </button>
            </div>
        </div>

        <div id="tasks" class="page">
            <h3 style="margin-top:0;">Earn Tasks</h3>
            <div style="width: 90%;" id="task-list"></div>
        </div>

        <div id="profile" class="page">
            <h3 style="margin-top:0;">Wallet</h3>
            <div class="card" style="width: 85%; margin: 20px auto; padding: 25px;">
                <p style="color: var(--text-secondary);">Total Balance</p>
                <h2 id="stat-balance" style="margin: 10px 0; color: var(--primary); font-size: 32px;">0 ü•ï</h2>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button class="btn-prime" style="background: var(--danger); flex: 1;" onclick="tg.showAlert('Coming Soon!')">WITHDRAW</button>
                    <button class="btn-prime" style="background: var(--success); flex: 1;" onclick="tg.showAlert('Coming Soon!')">DEPOSIT</button>
                </div>
            </div>
        </div>

        <nav class="nav-bar">
            <button class="nav-item active" onclick="nav('home', this)">
                <div class="icon-box">üè†</div>Home
            </button>
            <button class="nav-item" onclick="nav('upgrade', this)">
                <div class="icon-box">‚õèÔ∏è</div>Mine
            </button>
            <button id="boost-nav" class="nav-item" onclick="nav('boost', this)">
                <div class="icon-box">üöÄ</div>Boost
            </button>
            <button class="nav-item" onclick="nav('tasks', this)">
                <div class="icon-box">üìã</div>Tasks
            </button>
            <button class="nav-item" onclick="nav('profile', this)">
                <div class="icon-box">üëõ</div>Wallet
            </button>
        </nav>
    </div>

    <div id="web3-app">
        <div class="web3-header">
            <button class="back-btn" onclick="closeWeb3()">
                ‚¨Ö Back to Rabbit
            </button>
            <div style="font-weight:bold; color:var(--web3-primary);">WEB3 PORTAL</div>
        </div>

        <div class="web3-nav">
            <div class="w-nav-btn active" onclick="switchWeb3('w-home', this)">Home</div>
            <div class="w-nav-btn" onclick="switchWeb3('w-game', this)">Play</div>
            <div class="w-nav-btn" onclick="switchWeb3('w-profile', this)">Profile</div>
        </div>

        <div id="w-home" class="w-section w-active">
            <div style="text-align:center; margin-top:20px;">
                <h2 style="margin-bottom:5px;">Hey <span id="w-username" style="color:var(--web3-primary);">User</span> üëã</h2>
                <p style="color:#888; margin-top:0;">Welcome to Web3 Ecosystem</p>
                
                <div class="web3-card" style="text-align:center;">
                    <p style="color:#aaa; font-size:12px; text-transform:uppercase;">Web3 Balance</p>
                    <div style="display:flex; justify-content:center; align-items:center; margin-top:10px;">
                        <div class="b-coin">B</div>
                        <span id="w-balance" style="font-size:35px; font-weight:bold;">0</span>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:90%; margin:0 auto;">
                    <div class="web3-card" style="margin:0; padding:15px;">
                        <div style="font-size:24px;">üéÆ</div>
                        <div style="font-size:12px; margin-top:5px; color:#aaa;">Games Played</div>
                        <b id="w-games-played">0</b>
                    </div>
                    <div class="web3-card" style="margin:0; padding:15px;">
                        <div style="font-size:24px;">üìà</div>
                        <div style="font-size:12px; margin-top:5px; color:#aaa;">Total Earned</div>
                        <b id="w-total-earned">0</b>
                    </div>
                </div>
            </div>
        </div>

        <div id="w-game" class="w-section">
            <div style="text-align:center;">
                <h3>Flappy Bird Web3</h3>
                <p style="color:#888; font-size:12px; margin-bottom:15px;">Fly to earn 'B' Coins!</p>
                <canvas id="game-canvas" width="300" height="400"></canvas>
                <button class="btn-prime" style="background:var(--web3-primary); width:200px; margin-top:20px;" onclick="startGame()">‚ñ∂ PLAY GAME</button>
                <p style="color:#aaa; font-size:11px; margin-top:10px;">Tap screen or Click to Fly</p>
            </div>
        </div>

        <div id="w-profile" class="w-section">
            <div style="text-align:center; padding:0 20px;">
                <h3>My Web3 Wallet</h3>
                
                <div class="web3-card">
                    <p style="color:#aaa; font-size:12px;">Today's Game Profit</p>
                    <h2 id="w-today-profit" style="color:var(--success); margin:5px 0;">+0 B</h2>
                </div>

                <div class="web3-card">
                    <h4 style="margin-top:0;">üîÑ Convert Assets</h4>
                    <p style="font-size:11px; color:#666; margin-bottom:15px;">Rate: 1 B = 10 Carrots (ü•ï)</p>
                    
                    <div class="convert-box">
                        <div style="display:flex; align-items:center;">
                            <div class="b-coin" id="c-icon-from" style="width:30px; height:30px; font-size:16px;">B</div>
                            <span id="c-name-from" style="margin-left:5px; font-size:12px;">Web3</span>
                        </div>
                        <input type="number" id="convert-amount" class="convert-inp" placeholder="0" oninput="calcConvert()">
                    </div>

                    <div style="margin:-15px 0; position:relative; z-index:10;" onclick="toggleConvertDir()">
                        <span class="swap-icon">‚¨á</span>
                    </div>

                    <div class="convert-box">
                        <div style="display:flex; align-items:center;">
                            <span id="c-icon-to" style="font-size:24px;">ü•ï</span>
                            <span id="c-name-to" style="margin-left:5px; font-size:12px;">Carrot</span>
                        </div>
                        <div id="convert-result" style="font-family:'Orbitron'; font-size:20px;">0</div>
                    </div>

                    <button class="btn-prime" style="background:#fff; color:#000;" onclick="executeConvert()">CONVERT NOW</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.backgroundColor = '#08080a';
        tg.headerColor = '#08080a';

        // --- GLOBAL STATE ---
        let coins = parseFloat(localStorage.getItem('rabbit_coins')) || 0;
        let pph = 0;
        let energy = parseFloat(localStorage.getItem('rabbit_energy')) || 1000;
        let maxEnergy = 1000;
        let baseTapPower = 1;
        let rechargeRate = 1;
        
        let lastTime = parseInt(localStorage.getItem('rabbit_lastTime')) || Date.now();
        const today = new Date().toDateString();
        
        // --- REFILL & TURBO LIMITS ---
        let refillsLeft = parseInt(localStorage.getItem('rabbit_refillsLeft') || '5');
        let turboLeft = parseInt(localStorage.getItem('rabbit_turboLeft') || '5');
        let lastRefillDate = localStorage.getItem('rabbit_lastRefillDate') || '';

        if (lastRefillDate !== today) {
            refillsLeft = 5;
            turboLeft = 5;
            localStorage.setItem('rabbit_refillsLeft', 5);
            localStorage.setItem('rabbit_turboLeft', 5);
            localStorage.setItem('rabbit_lastRefillDate', today);
        }

        // Turbo Logic
        let turboActive = false;
        let turboTapsLeft = 0;

        // Daily Claim
        let lastDailyClaim = localStorage.getItem('rabbit_lastDailyClaim') || '';

        // Skins
        let currentSkin = localStorage.getItem('rabbit_skin') || 'üê∞';
        const skins = [
            {id: 'def', icon: 'üê∞', name: 'Classic', price: 0},
            {id: 'red', icon: 'üòà', name: 'Demon', price: 5000},
            {id: 'blue', icon: 'ü•∂', name: 'Frozen', price: 10000},
            {id: 'gold', icon: 'üëë', name: 'Gold', price: 50000},
            {id: 'alien', icon: 'üëΩ', name: 'Alien', price: 20000},
            {id: 'robot', icon: 'ü§ñ', name: 'Mecha', price: 30000},
            {id: 'skull', icon: 'üíÄ', name: 'Undead', price: 40000},
            {id: 'clown', icon: 'ü§°', name: 'Joker', price: 15000},
            {id: 'ninja', icon: 'ü•∑', name: 'Ninja', price: 25000},
            {id: 'king', icon: 'ü¶Å', name: 'King', price: 100000}
        ];
        let ownedSkins = JSON.parse(localStorage.getItem('rabbit_ownedSkins')) || ['def'];

        // Upgrades
        const upgrades = [
            {id: 'multitap', name: 'Strong Hand', icon: 'üëÜ', level: parseInt(localStorage.getItem('up_multitap') || '0'), baseCost: 500, multiplier: 1.8},
            {id: 'maxenergy', name: 'Battery Pack', icon: 'üîã', level: parseInt(localStorage.getItem('up_maxenergy') || '0'), baseCost: 1000, multiplier: 1.8},
            {id: 'recharge', name: 'Flash Charge', icon: '‚ö°', level: parseInt(localStorage.getItem('up_recharge') || '0'), baseCost: 2000, multiplier: 1.8},
            {id: 'miner1', name: 'Baby Rabbit', icon: 'üë∂', level: parseInt(localStorage.getItem('up_miner1') || '0'), baseCost: 200, multiplier: 1.8, baseProfit: 100},
            {id: 'miner2', name: 'Carrot Farm', icon: 'üöú', level: parseInt(localStorage.getItem('up_miner2') || '0'), baseCost: 1000, multiplier: 1.9, baseProfit: 500},
            {id: 'miner3', name: 'Robot Miner', icon: 'ü¶æ', level: parseInt(localStorage.getItem('up_miner3') || '0'), baseCost: 5000, multiplier: 2.0, baseProfit: 2000},
        ];

        // Tasks
        const taskData = [
            {id: 't1', title: 'Join Channel 1', reward: 5000, link: 'https://t.me/jkt_earning_zone20'},
            {id: 't2', title: 'Join Support', reward: 5000, link: 'https://t.me/jkt_support99'},
            {id: 't3', title: 'Join Community', reward: 10000, link: 'https://t.me/+cAq8TiohRXIzZmFl'}
        ];
        let userTasks = JSON.parse(localStorage.getItem('rabbit_tasks')) || {};

        // --- WEB3 STATE ---
        let web3Balance = parseFloat(localStorage.getItem('w3_balance')) || 0;
        let web3GamesPlayed = parseInt(localStorage.getItem('w3_games')) || 0;
        let web3TotalEarned = parseFloat(localStorage.getItem('w3_earned')) || 0;
        let web3TodayProfit = 0; // Reset on session for demo
        let convertDirection = 'BtoC'; // or 'CtoB'

        // --- INIT ---
        window.onload = function() {
            let count = 0;
            const counter = document.getElementById('loader-count');
            const fill = document.getElementById('loader-fill');
            const loader = document.getElementById('loading-screen');
            const modal = document.getElementById('agreement-modal');
            const hasAgreed = localStorage.getItem('rabbit_hasAgreed');

            // Web3 Username
            const username = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.first_name : 'Rabbit Miner';
            document.getElementById('w-username').innerText = username;

            const interval = setInterval(() => {
                count += Math.floor(Math.random() * 5) + 1;
                if(count > 100) count = 100;
                counter.innerText = count + '%';
                fill.style.width = count + '%';
                if(count === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => {
                            loader.style.display = 'none';
                            if (!hasAgreed) modal.style.display = 'flex';
                        }, 500);
                    }, 500);
                }
            }, 30);

            document.getElementById('tap-btn').innerText = currentSkin;
            renderTasks();
            updateUI();
            updateWeb3UI();
        }

        function handleAgreement(agreed) {
            const modal = document.getElementById('agreement-modal');
            if (agreed) {
                localStorage.setItem('rabbit_hasAgreed', 'true');
                modal.style.opacity = '0';
                setTimeout(() => { modal.style.display = 'none'; }, 300);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.close();
            }
        }

        // --- CORE LOOPS ---
        function calculateStats() {
            baseTapPower = 1 + (upgrades.find(u => u.id === 'multitap')?.level || 0);
            maxEnergy = 1000 + (upgrades.find(u => u.id === 'maxenergy')?.level || 0) * 500;
            rechargeRate = 1 + (upgrades.find(u => u.id === 'recharge')?.level || 0);
            pph = 0;
            upgrades.forEach(u => { if (u.baseProfit) pph += u.baseProfit * u.level; });
        }

        const nowNow = Date.now();
        const deltaSeconds = Math.floor((nowNow - lastTime) / 1000);
        if (deltaSeconds > 0) {
            calculateStats();
            coins += (pph / 3600) * deltaSeconds;
            energy += rechargeRate * deltaSeconds;
            if (energy > maxEnergy) energy = maxEnergy;
        }
        
        setInterval(() => {
            coins += pph / 3600;
            energy += rechargeRate;
            if (energy > maxEnergy) energy = maxEnergy;
            lastTime = Date.now();
            localStorage.setItem('rabbit_lastTime', lastTime);
            updateUI();
        }, 1000);

        // --- MAIN ACTIONS ---
        const rabbit = document.getElementById('tap-btn');
        rabbit.addEventListener('touchstart', (e) => {
            e.preventDefault();
            Array.from(e.changedTouches).forEach(touch => {
                let currentPower = baseTapPower;
                let isTurbo = false;

                if (turboActive && turboTapsLeft > 0) {
                    currentPower = baseTapPower * 5; 
                    turboTapsLeft--;
                    isTurbo = true;
                    if(turboTapsLeft <= 0) turboActive = false;
                }

                if (energy >= currentPower) {
                    energy -= currentPower;
                    coins += currentPower;
                    
                    const f = document.createElement('div');
                    f.className = 'float';
                    if(isTurbo) {
                        f.innerHTML = `‚ö° +${currentPower}`;
                        f.style.color = '#fff';
                    } else {
                        f.innerHTML = `ü•ï +${currentPower}`;
                        f.style.color = 'orange';
                    }
                    f.style.left = (touch.clientX - 20) + 'px';
                    f.style.top = (touch.clientY - 60) + 'px';
                    document.body.appendChild(f);
                    setTimeout(() => f.remove(), 1000);

                    rabbit.classList.add('tapped');
                    setTimeout(() => rabbit.classList.remove('tapped'), 100);
                    tg.HapticFeedback.impactOccurred(isTurbo ? 'heavy' : 'medium');
                }
            });
            updateUI();
        });

        function claimDaily() {
            if (lastDailyClaim === today) return;
            const reward = Math.max(1000, pph * 24);
            coins += reward;
            lastDailyClaim = today;
            localStorage.setItem('rabbit_lastDailyClaim', today);
            updateUI();
            tg.showAlert(`Claimed ${reward.toLocaleString()} carrots!`);
            tg.HapticFeedback.notificationOccurred('success');
        }

        function refill() {
            if (energy >= maxEnergy) { tg.showAlert("Energy is Full!"); return; }
            if (refillsLeft > 0) {
                energy = maxEnergy;
                refillsLeft--;
                localStorage.setItem('rabbit_refillsLeft', refillsLeft);
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.showAlert('No refills left today!');
            }
        }

        function activateTurbo() {
            if (turboActive) { tg.showAlert("Turbo already active!"); return; }
            if (turboLeft > 0) {
                turboLeft--;
                localStorage.setItem('rabbit_turboLeft', turboLeft);
                turboActive = true;
                turboTapsLeft = 100;
                tg.showAlert("üî• x5 Turbo Activated for 100 Taps!");
                nav('home', document.querySelector('.nav-item.active'));
                updateUI();
            } else {
                tg.showAlert("Daily Limit Reached (5/5)!");
            }
        }

        // --- SKINS LOGIC (NEW) ---
        function openSkins() {
            const modal = document.getElementById('skin-modal');
            const list = document.getElementById('skin-list');
            modal.style.display = 'flex';
            list.innerHTML = '';
            skins.forEach(s => {
                const owned = ownedSkins.includes(s.id);
                const selected = currentSkin === s.icon;
                
                list.innerHTML += `
                    <div class="skin-item ${selected ? 'selected' : (owned ? 'owned' : '')}" onclick="clickedSkin('${s.id}')">
                        <span class="skin-icon">${s.icon}</span>
                        <div style="font-size:12px; font-weight:bold; color:white;">${s.name}</div>
                        <div style="font-size:10px; color:${owned ? '#00c851' : 'var(--primary)'}; margin-top:5px;">
                            ${owned ? (selected ? 'Equipped' : 'Tap to Equip') : s.price.toLocaleString() + ' ü•ï'}
                        </div>
                    </div>
                `;
            });
        }

        function clickedSkin(id) {
            const s = skins.find(x => x.id === id);
            const owned = ownedSkins.includes(id);
            const title = owned ? "Equip Skin?" : "Buy Skin?";
            const desc = owned ? `Equip ${s.name} skin for free?` : `Buy ${s.name} for ${s.price.toLocaleString()} carrots?`;
            
            showSkinConfirm(s.icon, title, desc, () => {
                if(owned) equipSkin(s.icon);
                else buySkin(id);
            });
        }

        function showSkinConfirm(icon, title, desc, callback) {
            document.getElementById('sc-title').innerText = title;
            document.getElementById('sc-icon').innerText = icon;
            document.getElementById('sc-desc').innerText = desc;
            
            const yesBtn = document.getElementById('sc-yes-btn');
            yesBtn.onclick = () => {
                callback();
                closeSkinConfirm();
            };
            
            document.getElementById('skin-confirm-modal').style.display = 'flex';
        }

        function closeSkinConfirm() {
            document.getElementById('skin-confirm-modal').style.display = 'none';
        }

        function closeSkins() { document.getElementById('skin-modal').style.display = 'none'; }

        function buySkin(id) {
            const s = skins.find(x => x.id === id);
            if(coins >= s.price) {
                coins -= s.price;
                ownedSkins.push(id);
                localStorage.setItem('rabbit_ownedSkins', JSON.stringify(ownedSkins));
                equipSkin(s.icon);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.showAlert("Not enough carrots!");
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function equipSkin(icon) {
            currentSkin = icon;
            localStorage.setItem('rabbit_skin', currentSkin);
            document.getElementById('tap-btn').innerText = currentSkin;
            openSkins(); 
        }

        // --- TASKS & UPGRADES (Existing logic) ---
        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            taskData.forEach(t => {
                const status = userTasks[t.id] || 0;
                let btnHtml = '';
                if (status === 0) btnHtml = `<button class="task-btn btn-join" style="background:#fff; color:#000; padding:8px 16px; border-radius:8px; border:none;" onclick="openTask('${t.id}', '${t.link}')">Join</button>`;
                else if (status === 1) btnHtml = `<button class="task-btn btn-check" style="background:var(--primary); color:#fff; padding:8px 16px; border-radius:8px; border:none;" onclick="checkTask('${t.id}')">Check</button>`;
                else if (status === 2) btnHtml = `<button class="task-btn" style="background:#333; color:#888; padding:8px 16px; border-radius:8px; border:none;" disabled>Done</button>`;

                list.innerHTML += `
                    <div class="task-row" style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.03); padding:15px; border-radius:15px; margin-bottom:10px; border:1px solid var(--border);">
                        <div class="task-info">
                            <h4 style="margin:0; font-size:14px;">${t.title}</h4>
                            <p style="margin:5px 0 0; font-size:11px; color:var(--primary);">+${t.reward.toLocaleString()} ü•ï</p>
                        </div>
                        <div>${btnHtml}</div>
                    </div>`;
            });
        }
        function openTask(id, link) { window.open(link, '_blank'); userTasks[id] = 1; localStorage.setItem('rabbit_tasks', JSON.stringify(userTasks)); renderTasks(); }
        function checkTask(id) {
            tg.showPopup({title: 'Checking...', message: 'Verifying subscription...', buttons: [{type:'ok'}]});
            setTimeout(() => {
                const t = taskData.find(x => x.id === id);
                coins += t.reward;
                userTasks[id] = 2;
                localStorage.setItem('rabbit_tasks', JSON.stringify(userTasks));
                updateUI(); renderTasks(); tg.showAlert(`Verified! +${t.reward} ü•ï`);
            }, 2000);
        }

        function generateUpgrades() {
            const list = document.getElementById('upgrade-list');
            list.innerHTML = '';
            upgrades.forEach(u => {
                const cost = Math.floor(u.baseCost * Math.pow(u.multiplier, u.level));
                let effect = u.id === 'multitap' ? '+1 Tap' : (u.id === 'maxenergy' ? '+500 Energy' : (u.id === 'recharge' ? '+1 Speed' : `+${u.baseProfit}/hr`));
                list.innerHTML += `
                    <div class="card">
                        <div style="font-size:30px; margin-bottom:5px;">${u.icon}</div>
                        <h4 style="margin:0">${u.name}</h4>
                        <div style="font-size:11px; color:#888; margin:5px 0;">Lvl ${u.level} ‚Ä¢ ${effect}</div>
                        <button class="btn-prime" style="font-size:12px; padding:8px;" onclick="buyUpgrade('${u.id}')">${cost.toLocaleString()} ü•ï</button>
                    </div>`;
            });
        }

        function buyUpgrade(id) {
            const u = upgrades.find(up => up.id === id);
            const cost = Math.floor(u.baseCost * Math.pow(u.multiplier, u.level));
            if (coins >= cost) {
                coins -= cost; u.level++;
                localStorage.setItem('up_' + id, u.level);
                calculateStats(); updateUI(); generateUpgrades(); tg.HapticFeedback.notificationOccurred('success');
            } else { tg.showAlert('Not enough carrots!'); }
        }

        function nav(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(btn) btn.classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        // --- WEB3 LOGIC (NEW) ---
        function openWeb3() {
            document.getElementById('web3-app').style.display = 'flex';
            updateWeb3UI();
        }
        function closeWeb3() {
            document.getElementById('web3-app').style.display = 'none';
        }
        function switchWeb3(id, btn) {
            document.querySelectorAll('.w-section').forEach(s => s.classList.remove('w-active'));
            document.getElementById(id).classList.add('w-active');
            document.querySelectorAll('.w-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Web3 Convert Logic
        function toggleConvertDir() {
            convertDirection = convertDirection === 'BtoC' ? 'CtoB' : 'BtoC';
            const iconFrom = document.getElementById('c-icon-from');
            const nameFrom = document.getElementById('c-name-from');
            const iconTo = document.getElementById('c-icon-to');
            const nameTo = document.getElementById('c-name-to');
            
            if(convertDirection === 'BtoC') {
                iconFrom.innerText = 'B'; iconFrom.className = 'b-coin'; iconFrom.style.fontSize='16px';
                nameFrom.innerText = 'Web3';
                iconTo.innerText = 'ü•ï'; iconTo.className = ''; iconTo.style.fontSize='24px';
                nameTo.innerText = 'Carrot';
            } else {
                iconFrom.innerText = 'ü•ï'; iconFrom.className = ''; iconFrom.style.fontSize='24px';
                nameFrom.innerText = 'Carrot';
                iconTo.innerText = 'B'; iconTo.className = 'b-coin'; iconTo.style.fontSize='16px';
                nameTo.innerText = 'Web3';
            }
            calcConvert();
        }
        function calcConvert() {
            const val = parseFloat(document.getElementById('convert-amount').value) || 0;
            const res = document.getElementById('convert-result');
            if(convertDirection === 'BtoC') res.innerText = Math.floor(val * 10).toLocaleString(); // 1 B = 10 Carrot
            else res.innerText = (val / 10).toFixed(2); // 10 Carrot = 1 B
        }
        function executeConvert() {
            const val = parseFloat(document.getElementById('convert-amount').value) || 0;
            if(val <= 0) return;

            if(convertDirection === 'BtoC') {
                if(web3Balance >= val) {
                    web3Balance -= val;
                    coins += Math.floor(val * 10);
                    saveWeb3();
                    tg.showAlert('Conversion Successful!');
                } else tg.showAlert('Insufficient Web3 Balance!');
            } else {
                if(coins >= val) {
                    coins -= val;
                    web3Balance += (val / 10);
                    saveWeb3();
                    tg.showAlert('Conversion Successful!');
                } else tg.showAlert('Insufficient Carrots!');
            }
            updateWeb3UI(); updateUI();
            document.getElementById('convert-amount').value = '';
            document.getElementById('convert-result').innerText = '0';
        }

        function saveWeb3() {
            localStorage.setItem('w3_balance', web3Balance);
            localStorage.setItem('w3_games', web3GamesPlayed);
            localStorage.setItem('w3_earned', web3TotalEarned);
        }

        function updateWeb3UI() {
            document.getElementById('w-balance').innerText = web3Balance.toFixed(1);
            document.getElementById('w-games-played').innerText = web3GamesPlayed;
            document.getElementById('w-total-earned').innerText = web3TotalEarned.toFixed(1);
            document.getElementById('w-today-profit').innerText = '+' + web3TodayProfit.toFixed(1) + ' B';
        }

        // --- GAME LOGIC (Flappy Style) ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let gameActive = false;
        let bird = {x: 50, y: 200, dy: 0, size: 20};
        let pipes = [];
        let score = 0;
        let frame = 0;

        function startGame() {
            if(gameActive) return;
            gameActive = true;
            bird.y = 200; bird.dy = 0;
            pipes = []; score = 0; frame = 0;
            loop();
        }

        function loop() {
            if(!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Bird Physics
            bird.dy += 0.4; // Gravity
            bird.y += bird.dy;
            
            // Draw Bird
            ctx.fillStyle = '#ffeb3b';
            ctx.fillRect(bird.x, bird.y, bird.size, bird.size);
            ctx.strokeStyle = '#000';
            ctx.strokeRect(bird.x, bird.y, bird.size, bird.size);

            // Pipe Logic
            if(frame % 90 === 0) {
                const gap = 100;
                const topH = Math.random() * (canvas.height - gap - 50) + 20;
                pipes.push({x: canvas.width, top: topH, gap: gap});
            }

            pipes.forEach((p, i) => {
                p.x -= 2;
                // Draw Pipe
                ctx.fillStyle = '#4caf50';
                ctx.fillRect(p.x, 0, 40, p.top);
                ctx.fillRect(p.x, p.top + p.gap, 40, canvas.height - (p.top + p.gap));
                
                // Collision
                if(bird.x < p.x + 40 && bird.x + bird.size > p.x &&
                   (bird.y < p.top || bird.y + bird.size > p.top + p.gap)) {
                    endGame();
                }
                // Score
                if(p.x + 40 < bird.x && !p.passed) {
                    score++;
                    p.passed = true;
                }
            });

            // Floor/Ceil Collision
            if(bird.y + bird.size > canvas.height || bird.y < 0) endGame();

            // Draw Score
            ctx.fillStyle = 'white';
            ctx.font = '20px Orbitron';
            ctx.fillText(score, 10, 30);

            frame++;
            requestAnimationFrame(loop);
        }

        canvas.addEventListener('mousedown', jump);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });

        function jump() { bird.dy = -6; }

        function endGame() {
            gameActive = false;
            // Reward: 1 Point per score
            const earn = score;
            web3Balance += earn;
            web3TodayProfit += earn;
            web3TotalEarned += earn;
            web3GamesPlayed++;
            saveWeb3();
            updateWeb3UI();
            
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = '20px Inter';
            ctx.fillText('Game Over', 100, 180);
            ctx.fillText(`Score: ${score}`, 110, 210);
            ctx.fillStyle = '#ff9800';
            ctx.fillText(`+${earn} B`, 125, 240);
        }

        function updateUI() {
            document.getElementById('coins').innerText = Math.floor(coins).toLocaleString();
            document.getElementById('stat-balance').innerText = Math.floor(coins).toLocaleString() + " ü•ï";
            document.getElementById('pph').innerText = pph.toLocaleString();
            const dailyIncome = Math.max(1000, pph * 24);
            document.getElementById('daily-estimate').innerText = dailyIncome.toLocaleString();
            document.getElementById('energy-fill').style.width = (energy / maxEnergy * 100) + '%';
            document.getElementById('energy-text').innerText = Math.floor(energy) + ' / ' + maxEnergy;
            
            document.getElementById('refill-btn').innerText = `Refill Energy (${refillsLeft}/5)`;
            if(refillsLeft <= 0) { document.getElementById('refill-btn').style.opacity = '0.5'; }
            
            document.getElementById('turbo-btn').innerText = `Activate (${turboLeft}/5)`;
            if(turboLeft <= 0) { document.getElementById('turbo-btn').style.opacity = '0.5'; }

            const dailyBtn = document.getElementById('daily-btn');
            if (lastDailyClaim === today) {
                dailyBtn.innerText = `Come back tomorrow (+${dailyIncome.toLocaleString()})`;
                dailyBtn.disabled = true; dailyBtn.style.opacity = '0.5'; dailyBtn.classList.remove('glow-btn');
            } else {
                dailyBtn.innerText = `Claim Daily (+${dailyIncome.toLocaleString()})`;
                dailyBtn.disabled = false; dailyBtn.style.opacity = '1'; dailyBtn.classList.add('glow-btn');
                dailyBtn.onclick = claimDaily;
            }
            localStorage.setItem('rabbit_coins', coins);
            localStorage.setItem('rabbit_energy', energy);
        }

        // Initialize
        calculateStats();
        generateUpgrades();
        updateUI();

    </script>
</body>
</html>
