<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rabbit Miner Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff9800;
            --primary-glow: rgba(255, 152, 0, 0.6);
            --bg: #08080a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text-secondary: #a0a0a0;
            --danger: #ff4444;
            --success: #00c851;
        }
        body {
            margin: 0;
            background: radial-gradient(circle at top, #1a1a1f 0%, #08080a 100%);
            color: white;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- LOADING --- */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader-number {
            font-family: 'Orbitron', sans-serif;
            font-size: 60px; color: var(--primary);
            text-shadow: 0 0 20px var(--primary-glow); margin-bottom: 20px;
        }
        .loader-bar-bg { width: 70%; height: 6px; background: #222; border-radius: 10px; overflow: hidden; }
        .loader-bar-fill { height: 100%; width: 0%; background: var(--primary);
            box-shadow: 0 0 10px var(--primary); transition: width 0.1s linear; }

        /* --- MODAL --- */
        #agreement-modal, #skin-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); z-index: 9998;
            display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .agreement-box {
            background: #151518;
            border: 1px solid var(--primary); box-shadow: 0 0 30px rgba(255, 152, 0, 0.15);
            width: 85%; max-width: 400px; padding: 30px; border-radius: 24px;
            text-align: center;
        }
        .btn-agree, .btn-deny {
            flex: 1;
            padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer;
        }
        .btn-agree { background: linear-gradient(135deg, #ff9800, #ff6d00); color: white; }
        .btn-deny { background: #2a2a2a; color: #ff4444; border: 1px solid #ff4444; }

        /* --- MAIN UI --- */
        .top-bar { 
            position: fixed;
            top: 0; left: 0; width: 100%; background: var(--bg); z-index: 50; 
            padding: 15px 0 20px 0; text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .balance-area { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .balance-area .coin-icon { font-size: 35px; filter: drop-shadow(0 0 10px var(--primary-glow)); }
        
        #coins {
            font-size: 38px;
            font-family: 'Orbitron', sans-serif; font-weight: 700;
            background: linear-gradient(to bottom, #fff, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; padding: 0 20px; }
        .stat-box { background: var(--card-bg); border: 1px solid var(--border);
            padding: 10px; border-radius: 16px; backdrop-filter: blur(10px); }
        .stat-box small { display: block;
            color: var(--text-secondary); font-size: 10px; text-transform: uppercase; margin-bottom: 4px; }
        .stat-box b { font-size: 16px; color: #fff; }

        .page {
            display: none;
            flex-direction: column; align-items: center; width: 100%; height: 100vh;
            overflow-y: auto; -webkit-overflow-scrolling: touch; padding-top: 180px; padding-bottom: 120px; box-sizing: border-box;
            position: absolute;
            top: 0; left: 0;
        }
        .active-page { display: flex; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BIGGER RABBIT --- */
        .rabbit-container { 
            flex: 0 0 auto;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; width: 100%; margin-top: 10px; margin-bottom: 10px;
        }
        .circle-outer {
            width: 300px;
            height: 300px; border-radius: 50%;
            background: rgba(255, 152, 0, 0.05);
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255, 152, 0, 0.1);
        }
        .rabbit-main {
            width: 260px;
            height: 260px;
            background: radial-gradient(circle, #2a2a2a, #000);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 110px; cursor: pointer;
            box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,152,0,0.1);
            border: 5px solid #1a1a1a; transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
            line-height: 1; /* Fix vertical align of emoji */
        }
        .rabbit-main:active { transform: scale(0.95); }
        .rabbit-main.tapped { animation: tapBounce 0.4s ease-out; box-shadow: 0 0 70px var(--primary-glow); }
        @keyframes tapBounce { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }

        /* --- ANIMATIONS & FLOATING --- */
        .energy-container { margin-top: 15px; width: 80%; text-align: center; }
        .energy-bar-bg { height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin: 8px 0; }
        #energy-fill { height: 100%;
            background: linear-gradient(90deg, var(--primary), #f57c00); width: 100%; transition: width 0.3s ease; }
        
        .float {
            position: absolute;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold; color: #fff; font-size: 24px;
            pointer-events: none; animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px #000; z-index: 100;
            display: flex; align-items: center; gap: 5px;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-150px) scale(1.2); } }

        /* --- BUTTONS & CARDS --- */
        .upgrade-grid { display: grid;
            grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px; width: 100%; box-sizing: border-box; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 15px;
            text-align: center; margin-bottom: 10px; }
        .btn-prime {
            background: linear-gradient(90deg, #ff9800, #f57c00);
            color: white; border: none; 
            padding: 12px; border-radius: 12px; width: 100%; font-weight: 600; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); transition: all 0.2s;
        }
        .btn-prime:active { transform: scale(0.98); }
        .btn-prime:disabled { background: #333; color: #777; box-shadow: none; cursor: not-allowed; }
        
        .glow-btn { animation: glowing 1.5s infinite; }
        @keyframes glowing {
            0% { box-shadow: 0 0 5px #ff9800; }
            50% { box-shadow: 0 0 20px #ff9800; }
            100% { box-shadow: 0 0 5px #ff9800; }
        }

        /* --- TASKS --- */
        .task-row {
            display: flex;
            justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px;
            margin-bottom: 10px; border: 1px solid var(--border);
        }
        .task-info { text-align: left; }
        .task-info h4 { margin: 0; font-size: 14px; color: #fff; }
        .task-info p { margin: 5px 0 0; font-size: 11px; color: var(--primary); }
        .task-btn {
            padding: 8px 16px;
            border-radius: 8px; font-size: 12px; font-weight: bold; border: none; cursor: pointer;
        }
        .btn-join { background: #fff; color: #000; }
        .btn-check { background: var(--primary); color: #fff; }
        .btn-claim { background: var(--success); color: #fff; }
        .btn-done { background: #333; color: #888; }

        /* --- SKINS --- */
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); gap: 15px;
            max-height: 70vh; overflow-y: auto; padding: 10px;
        }
        .skin-item {
            background: #222;
            border-radius: 15px; padding: 15px; text-align: center;
            border: 2px solid transparent; cursor: pointer;
        }
        .skin-item.selected { border-color: var(--success); background: #1a3020; }
        .skin-icon { font-size: 50px; margin-bottom: 10px; display: block; }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed;
            bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 70px;
            background: rgba(20, 20, 25, 0.9); backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 40px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); padding: 0 5px;
        }
        .nav-item {
            background: none;
            border: none; color: var(--text-secondary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 600; padding: 5px; width: 55px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 20px;
        }
        .nav-item .icon-box { font-size: 22px;
            margin-bottom: 2px; transition: all 0.3s; filter: grayscale(1); }
        .nav-item.active { color: #fff;
            transform: translateY(-5px); }
        .nav-item.active .icon-box { transform: scale(1.1);
            filter: grayscale(0) drop-shadow(0 0 8px var(--primary)); }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader-number" id="loader-count">0%</div>
        <div class="loader-bar-bg"><div class="loader-bar-fill" id="loader-fill"></div></div>
        <p style="color:#666; margin-top:10px; font-size:12px;">Loading Assets...</p>
    </div>

    <div id="agreement-modal">
        <div class="agreement-box">
            <h2>WELCOME</h2>
            <div class="agreement-text">
                By entering <b>Rabbit Miner Pro</b>, you agree to our Terms.<br><br>
                Play fair, mine carrots, and enjoy!
            </div>
            <div style="display:flex; gap:15px;">
                <button class="btn-deny" onclick="handleAgreement(false)">DENY</button>
                <button class="btn-agree" onclick="handleAgreement(true)">AGREE</button>
            </div>
        </div>
    </div>

    <div id="skin-modal" style="display:none;">
        <div class="agreement-box" style="width:90%; max-width:400px; padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Select Skin</h3>
                <button onclick="closeSkins()" style="background:none; border:none; color:red; font-size:24px;">&times;</button>
            </div>
            <div class="skin-grid" id="skin-list"></div>
        </div>
    </div>

    <div class="top-bar">
        <div class="balance-area">
            <span class="coin-icon">ü•ï</span>
            <span id="coins">0</span>
        </div>
        <div class="stats-grid">
            <div class="stat-box">
                <small>Profit / Hr</small>
                <b id="pph">0</b>
            </div>
            <div class="stat-box">
                <small>Daily Reward</small>
                <b id="daily-estimate">0</b>
            </div>
        </div>
    </div>

    <div id="home" class="page active-page">
        <div class="rabbit-container">
            <div class="circle-outer">
                <div class="rabbit-main" id="tap-btn">üê∞</div>
            </div>
            <div class="energy-container">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa;">
                    <span>Energy</span>
                    <span id="energy-text">1000 / 1000</span>
                </div>
                <div class="energy-bar-bg">
                    <div id="energy-fill"></div>
                </div>
            </div>
        </div>
        
        <button class="btn-prime" id="daily-btn" style="width: 85%; margin-bottom: 10px;">
            Claim Daily
        </button>
        
        <button class="btn-prime" style="width: 85%; background: #333; margin-bottom: 20px;" onclick="nav('boost', document.getElementById('boost-nav'))">
              üöÄ BOOSTERS
        </button>
    </div>

    <div id="upgrade" class="page">
        <div style="width:90%; margin-bottom:15px;">
            <button class="btn-prime" onclick="openSkins()" style="background: linear-gradient(45deg, #9c27b0, #673ab7);">
                  üé® Buy Skins (Color Rabbits)
            </button>
        </div>
        <h3 style="margin-top:0;">Upgrades</h3>
        <div class="upgrade-grid" id="upgrade-list"></div>
    </div>

    <div id="boost" class="page">
        <h3 style="margin-top:0;">Boosters</h3>
        
        <div class="card" style="width: 80%; margin: 10px auto;">
            <h4>‚ö° Full Energy Refill</h4>
            <p style="color: var(--text-secondary); font-size: 13px;">Refill energy instantly.</p>
            <button class="btn-prime" id="refill-btn" onclick="refill()">Refill (5/5)</button>
        </div>

        <div class="card" style="width: 80%; margin: 10px auto; border: 1px solid #ff4444;">
            <h4 style="color:#ff4444;">üî• Turbo Rabbit (x5)</h4>
            <p style="color: var(--text-secondary); font-size: 13px;">Get x5 Multiplier for 100 Taps!</p>
            <button class="btn-prime" id="turbo-btn" onclick="activateTurbo()">
                Buy Turbo (10,000 ü•ï)
            </button>
        </div>
    </div>

    <div id="tasks" class="page">
        <h3 style="margin-top:0;">Earn Tasks</h3>
        <div style="width: 90%;" id="task-list"></div>
    </div>

    <div id="profile" class="page">
        <h3 style="margin-top:0;">Wallet</h3>
        <div class="card" style="width: 85%; margin: 20px auto; padding: 25px;">
            <p style="color: var(--text-secondary);">Total Balance</p>
            <h2 id="stat-balance" style="margin: 10px 0; color: var(--primary); font-size: 32px;">0 ü•ï</h2>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn-prime" style="background: var(--danger); flex: 1;" onclick="tg.showAlert('Coming Soon!')">WITHDRAW</button>
                <button class="btn-prime" style="background: var(--success); flex: 1;" onclick="tg.showAlert('Coming Soon!')">DEPOSIT</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="nav('home', this)">
            <div class="icon-box">üè†</div>Home
        </button>
        <button class="nav-item" onclick="nav('upgrade', this)">
            <div class="icon-box">‚õèÔ∏è</div>Mine
        </button>
        <button id="boost-nav" class="nav-item" onclick="nav('boost', this)">
            <div class="icon-box">üöÄ</div>Boost
        </button>
        <button class="nav-item" onclick="nav('tasks', this)">
            <div class="icon-box">üìã</div>Tasks
        </button>
        <button class="nav-item" onclick="nav('profile', this)">
            <div class="icon-box">üëõ</div>Wallet
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.backgroundColor = '#08080a';
        tg.headerColor = '#08080a';

        // --- GLOBAL STATE ---
        let coins = parseFloat(localStorage.getItem('rabbit_coins')) || 0;
        let pph = 0;
        let energy = parseFloat(localStorage.getItem('rabbit_energy')) || 1000;
        let maxEnergy = 1000;
        let baseTapPower = 1;
        let rechargeRate = 1;
        
        // Multiplier Logic
        let turboActive = false;
        let turboTapsLeft = 0;

        let lastTime = parseInt(localStorage.getItem('rabbit_lastTime')) || Date.now();
        const today = new Date().toDateString();

        // Daily Claim
        let lastDailyClaim = localStorage.getItem('rabbit_lastDailyClaim') || '';
        
        // Refills
        let storedRefills = localStorage.getItem('rabbit_refillsLeft');
        let refillsLeft = storedRefills === null ? 5 : parseInt(storedRefills);
        let lastRefillDate = localStorage.getItem('rabbit_lastRefillDate') || '';

        if (lastRefillDate !== today) {
            refillsLeft = 5;
            localStorage.setItem('rabbit_refillsLeft', refillsLeft);
            localStorage.setItem('rabbit_lastRefillDate', today);
        }

        // Skins (ADDED EMOJIS HERE)
        let currentSkin = localStorage.getItem('rabbit_skin') || 'üê∞';
        const skins = [
            {id: 'def', icon: 'üê∞', name: 'Classic', price: 0},
            {id: 'red', icon: 'üòà', name: 'Demon', price: 5000},
            {id: 'blue', icon: 'ü•∂', name: 'Frozen', price: 10000},
            {id: 'gold', icon: 'üëë', name: 'Gold', price: 50000},
            {id: 'alien', icon: 'üëΩ', name: 'Alien', price: 20000},
            {id: 'robot', icon: 'ü§ñ', name: 'Mecha', price: 30000},
            {id: 'skull', icon: 'üíÄ', name: 'Undead', price: 40000},
            {id: 'clown', icon: 'ü§°', name: 'Joker', price: 15000},
            {id: 'ninja', icon: 'ü•∑', name: 'Ninja', price: 25000},
            {id: 'king', icon: 'ü¶Å', name: 'King', price: 100000}
        ];
        let ownedSkins = JSON.parse(localStorage.getItem('rabbit_ownedSkins')) || ['def'];

        // Upgrades (ADDED EMOJIS HERE)
        const upgrades = [
            {id: 'multitap', name: 'Strong Hand', icon: 'üëÜ', level: parseInt(localStorage.getItem('up_multitap') || '0'), baseCost: 500, multiplier: 1.8},
            {id: 'maxenergy', name: 'Battery Pack', icon: 'üîã', level: parseInt(localStorage.getItem('up_maxenergy') || '0'), baseCost: 1000, multiplier: 1.8},
            {id: 'recharge', name: 'Flash Charge', icon: '‚ö°', level: parseInt(localStorage.getItem('up_recharge') || '0'), baseCost: 2000, multiplier: 1.8},
            {id: 'miner1', name: 'Baby Rabbit', icon: 'üë∂', level: parseInt(localStorage.getItem('up_miner1') || '0'), baseCost: 200, multiplier: 1.8, baseProfit: 100},
            {id: 'miner2', name: 'Carrot Farm', icon: 'üöú', level: parseInt(localStorage.getItem('up_miner2') || '0'), baseCost: 1000, multiplier: 1.9, baseProfit: 500},
            {id: 'miner3', name: 'Robot Miner', icon: 'ü¶æ', level: parseInt(localStorage.getItem('up_miner3') || '0'), baseCost: 5000, multiplier: 2.0, baseProfit: 2000},
        ];

        // Tasks
        const taskData = [
            {id: 't1', title: 'Join Channel 1', reward: 5000, link: 'https://t.me/jkt_earning_zone20'},
            {id: 't2', title: 'Join Support', reward: 5000, link: 'https://t.me/jkt_support99'},
            {id: 't3', title: 'Join Community', reward: 10000, link: 'https://t.me/+cAq8TiohRXIzZmFl'}
        ];
        
        // 0=init, 1=joined(checking), 2=claimed
        let userTasks = JSON.parse(localStorage.getItem('rabbit_tasks')) || {};

        // --- INIT & LOADING ---
        window.onload = function() {
            let count = 0;
            const counter = document.getElementById('loader-count');
            const fill = document.getElementById('loader-fill');
            const loader = document.getElementById('loading-screen');
            const modal = document.getElementById('agreement-modal');
            const hasAgreed = localStorage.getItem('rabbit_hasAgreed');

            const interval = setInterval(() => {
                count += Math.floor(Math.random() * 5) + 1;
                if(count > 100) count = 100;
                counter.innerText = count + '%';
                fill.style.width = count + '%';

                if(count === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => {
                            loader.style.display = 'none';
                            if (!hasAgreed) {
                                modal.style.display = 'flex';
                            }
                        }, 500);
                    }, 500);
                }
            }, 30);

            // Set current skin
            document.getElementById('tap-btn').innerText = currentSkin;
            renderTasks();
            updateUI();
        }

        function handleAgreement(agreed) {
            const modal = document.getElementById('agreement-modal');
            if (agreed) {
                localStorage.setItem('rabbit_hasAgreed', 'true');
                modal.style.opacity = '0';
                setTimeout(() => { modal.style.display = 'none'; }, 300);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.close();
            }
        }

        // --- CORE GAME LOOP ---
        function calculateStats() {
            baseTapPower = 1 + (upgrades.find(u => u.id === 'multitap')?.level || 0);
            maxEnergy = 1000 + (upgrades.find(u => u.id === 'maxenergy')?.level || 0) * 500;
            rechargeRate = 1 + (upgrades.find(u => u.id === 'recharge')?.level || 0);
            pph = 0;
            upgrades.forEach(u => {
                if (u.baseProfit) pph += u.baseProfit * u.level;
            });
        }

        // Idle Income Calculation
        const now = Date.now();
        const deltaSeconds = Math.floor((now - lastTime) / 1000);
        if (deltaSeconds > 0) {
            calculateStats();
            // Calculate PPH first
            coins += (pph / 3600) * deltaSeconds;
            energy += rechargeRate * deltaSeconds;
            if (energy > maxEnergy) energy = maxEnergy;
        }
        
        setInterval(() => {
            coins += pph / 3600;
            energy += rechargeRate;
            if (energy > maxEnergy) energy = maxEnergy;
            lastTime = Date.now();
            localStorage.setItem('rabbit_lastTime', lastTime);
            updateUI();
        }, 1000);

        // --- USER ACTIONS ---

        // 1. Tapping
        const rabbit = document.getElementById('tap-btn');
        rabbit.addEventListener('touchstart', (e) => {
            e.preventDefault();
            Array.from(e.changedTouches).forEach(touch => {
                // Determine Power
                let currentPower = baseTapPower;
                let isTurboTap = false;

                if (turboActive && turboTapsLeft > 0) {
                    currentPower = baseTapPower * 5; // Multiplier x5
                    turboTapsLeft--;
                    isTurboTap = true;
                    if(turboTapsLeft <= 0) turboActive = false;
                }

                if (energy >= currentPower) {
                    energy -= currentPower;
                    coins += currentPower;
                    
                    // Visuals
                    const f = document.createElement('div');
                    f.className = 'float';
                    
                    if(isTurboTap) {
                        f.innerHTML = `‚ö° +${currentPower}`;
                        f.style.color = '#fff'; // White
                    } else {
                        f.innerHTML = `ü•ï +${currentPower}`;
                        f.style.color = 'orange';
                    }
                    
                    f.style.left = (touch.clientX - 20) + 'px';
                    f.style.top = (touch.clientY - 60) + 'px';
                    document.body.appendChild(f);
                    setTimeout(() => f.remove(), 1000);

                    rabbit.classList.add('tapped');
                    setTimeout(() => rabbit.classList.remove('tapped'), 100);
                    tg.HapticFeedback.impactOccurred(isTurboTap ? 'heavy' : 'medium');
                }
            });
            updateUI();
        });

        // 2. Daily Claim
        function claimDaily() {
            if (lastDailyClaim === today) return;
            // Calculate reward: PPH * 24 (min 1000)
            const reward = Math.max(1000, pph * 24);
            coins += reward;
            lastDailyClaim = today;
            localStorage.setItem('rabbit_lastDailyClaim', today);
            
            updateUI();
            tg.showAlert(`Claimed ${reward.toLocaleString()} carrots!`);
            tg.HapticFeedback.notificationOccurred('success');
        }

        // 3. Boosters
        function refill() {
            if (energy >= maxEnergy) {
                tg.showAlert("Energy is Full!");
                return;
            }
            if (refillsLeft > 0) {
                energy = maxEnergy;
                refillsLeft--;
                localStorage.setItem('rabbit_refillsLeft', refillsLeft);
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.showAlert('No refills left today!');
            }
        }

        function activateTurbo() {
            if(coins >= 10000) {
                coins -= 10000;
                turboActive = true;
                turboTapsLeft = 100;
                tg.showAlert("üî• x5 Turbo Activated for 100 Taps!");
                nav('home', document.querySelector('.nav-item.active'));
            } else {
                tg.showAlert("Not enough coins!");
            }
        }

        // 4. Tasks
        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            taskData.forEach(t => {
                const status = userTasks[t.id] || 0; // 0=new, 1=check, 2=done
                let btnHtml = '';
                
                if (status === 0) {
                    btnHtml = `<button class="task-btn btn-join" onclick="openTask('${t.id}', '${t.link}')">Join</button>`;
                } else if (status === 1) {
                    btnHtml = `<button class="task-btn btn-check" onclick="checkTask('${t.id}')">Check</button>`;
                } else if (status === 2) {
                    btnHtml = `<button class="task-btn btn-done" disabled>Done</button>`;
                }

                list.innerHTML += `
                    <div class="task-row">
                        <div class="task-info">
                            <h4>${t.title}</h4>
                            <p>+${t.reward.toLocaleString()} ü•ï</p>
                        </div>
                        <div id="btn-${t.id}">${btnHtml}</div>
                    </div>
                `;
            });
        }

        function openTask(id, link) {
            window.open(link, '_blank');
            userTasks[id] = 1; // Mark as waiting check
            localStorage.setItem('rabbit_tasks', JSON.stringify(userTasks));
            renderTasks();
        }

        function checkTask(id) {
            tg.showPopup({
                title: 'Checking...',
                message: 'Verifying your subscription. Please wait 3 seconds.',
                buttons: [{type:'ok'}]
            });
            setTimeout(() => {
                // Claim logic
                const t = taskData.find(x => x.id === id);
                coins += t.reward;
                userTasks[id] = 2; // Done
                localStorage.setItem('rabbit_tasks', JSON.stringify(userTasks));
                updateUI();
                renderTasks();
                tg.showAlert(`Task Verified! received ${t.reward} ü•ï`);
                tg.HapticFeedback.notificationOccurred('success');
            }, 3000);
        }

        // 5. Skins
        function openSkins() {
            const modal = document.getElementById('skin-modal');
            const list = document.getElementById('skin-list');
            modal.style.display = 'flex';
            list.innerHTML = '';
            skins.forEach(s => {
                const owned = ownedSkins.includes(s.id);
                const selected = currentSkin === s.icon;
                let btnText = owned ? (selected ? 'Equipped' : 'Select') : `${s.price.toLocaleString()} ü•ï`;
                let btnAction = owned ? `equipSkin('${s.icon}')` : `buySkin('${s.id}')`;
                
                list.innerHTML += `
                    <div class="skin-item ${selected ? 'selected' : ''}" onclick="${btnAction}">
                        <span class="skin-icon">${s.icon}</span>
                        <div style="font-size:12px; font-weight:bold; color:white;">${s.name}</div>
                        <div style="font-size:10px; color:${owned ? '#00c851' : 'var(--primary)'}; margin-top:5px;">${btnText}</div>
                    </div>
                `;
            });
        }

        function closeSkins() {
            document.getElementById('skin-modal').style.display = 'none';
        }

        function buySkin(id) {
            const s = skins.find(x => x.id === id);
            if(coins >= s.price) {
                coins -= s.price;
                ownedSkins.push(id);
                localStorage.setItem('rabbit_ownedSkins', JSON.stringify(ownedSkins));
                equipSkin(s.icon);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.showAlert("Not enough carrots!");
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function equipSkin(icon) {
            currentSkin = icon;
            localStorage.setItem('rabbit_skin', currentSkin);
            document.getElementById('tap-btn').innerText = currentSkin;
            openSkins(); // Re-render
        }

        // --- UI UPDATES ---
        function generateUpgrades() {
            const list = document.getElementById('upgrade-list');
            list.innerHTML = '';
            upgrades.forEach(u => {
                const cost = Math.floor(u.baseCost * Math.pow(u.multiplier, u.level));
                let effect = '';
                if (u.id === 'multitap') effect = `+1 Tap`;
                else if (u.id === 'maxenergy') effect = `+500 Energy`;
                else if (u.id === 'recharge') effect = `+1 Speed`;
                else effect = `+${u.baseProfit}/hr`;

                list.innerHTML += `
                    <div class="card">
                        <div style="font-size:30px; margin-bottom:5px;">${u.icon}</div>
                        <h4 style="margin:0">${u.name}</h4>
                        <div style="font-size:11px; color:#888; margin:5px 0;">Lvl ${u.level} ‚Ä¢ ${effect}</div>
                        <button class="btn-prime" style="font-size:12px; padding:8px;" onclick="buyUpgrade('${u.id}')">
                            ${cost.toLocaleString()} ü•ï
                        </button>
                    </div>`;
            });
        }

        function buyUpgrade(id) {
            const u = upgrades.find(up => up.id === id);
            const cost = Math.floor(u.baseCost * Math.pow(u.multiplier, u.level));
            if (coins >= cost) {
                coins -= cost;
                u.level++;
                localStorage.setItem('up_' + id, u.level);
                calculateStats();
                updateUI();
                generateUpgrades();
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.showAlert('Not enough carrots!');
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function updateUI() {
            document.getElementById('coins').innerText = Math.floor(coins).toLocaleString();
            document.getElementById('stat-balance').innerText = Math.floor(coins).toLocaleString() + " ü•ï";
            document.getElementById('pph').innerText = pph.toLocaleString();
            
            const dailyIncome = Math.max(1000, pph * 24);
            document.getElementById('daily-estimate').innerText = dailyIncome.toLocaleString();

            document.getElementById('energy-fill').style.width = (energy / maxEnergy * 100) + '%';
            document.getElementById('energy-text').innerText = Math.floor(energy) + ' / ' + maxEnergy;
            document.getElementById('refill-btn').innerText = `Refill Energy (${refillsLeft}/5)`;
            
            // Refill Button State
            const refillBtn = document.getElementById('refill-btn');
            if(refillsLeft <= 0) {
                refillBtn.style.opacity = '0.5';
                refillBtn.innerText = 'No Refills Left';
            } else {
                refillBtn.style.opacity = '1';
            }

            // Daily Claim Button State
            const dailyBtn = document.getElementById('daily-btn');
            if (lastDailyClaim === today) {
                dailyBtn.innerText = `Come back tomorrow (+${dailyIncome.toLocaleString()})`;
                dailyBtn.disabled = true;
                dailyBtn.style.opacity = '0.5';
                dailyBtn.classList.remove('glow-btn');
            } else {
                dailyBtn.innerText = `Claim Daily (+${dailyIncome.toLocaleString()})`;
                dailyBtn.disabled = false;
                dailyBtn.style.opacity = '1';
                dailyBtn.classList.add('glow-btn');
                dailyBtn.onclick = claimDaily;
            }

            localStorage.setItem('rabbit_coins', coins);
            localStorage.setItem('rabbit_energy', energy);
        }

        function nav(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(btn) btn.classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        // Initialize UI components
        calculateStats();
        generateUpgrades();
        updateUI();

    </script>
</body>
</html>
